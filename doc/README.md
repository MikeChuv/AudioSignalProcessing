# Цифровая обратобка аудио сигналов на Python


**Соглашение:** аудиофайлы представленные во float32 должны иметь данные в диапазоне от -1 до 1
```python
# при загрузке файла происходит преобразование к float32 и диапазону [-1, 1]
INT16_FAC = (2**15)-1
INT32_FAC = (2**31)-1
INT64_FAC = (2**63)-1
norm_fact = {'int16':INT16_FAC, 'int32':INT32_FAC, 'int64':INT64_FAC,'float32':1.0,'float64':1.0}

#scale down and convert audio into floating point number in range of -1 to 1
x = np.float32(x)/norm_fact[x.dtype.name]
```


## Дискретное преобразование Фурье

$$
X\left[k\right] = \sum_{n=0}^{N-1}x[n] e^{-i \frac{2 \pi k n}{N}}, \quad k = 0, 1, 2 ...
$$

где $n$ - дискретный временной индекс (нормализованное время, период $T = 1$), $k$ - дискретный частотный индекс. 
Частота в герцах будет выражаться так: $f_{k} = f_{s} k / N$, где $f_{s}$ - частота дискретизации (аналогично, $f_k = \frac{k}{T}$, где $T$ - период измерения).

$e^{-i \frac{2 \pi k n}{N}} = \cos(\frac{2 \pi k n}{N}) - i \cdot \sin(\frac{2 \pi k n}{N})$


Дискретное преобразование Фурье как скалярное произведение:
Комплексную амплитуду сигнала некоторой $k$-той частоты можно получить, вычислив скалярное произведение сигнала и комплексной синусоиды этой частоты

$$
\langle x, s_{k} \rangle = \sum_{n=0}^{N-1} x[n]\overline{s_k}[n] = \sum_{n=0}^{N-1} x[n]e^{-i \frac{2 \pi k n}{N}}
$$ 

Происходит разложение на синусоидальные составляющие с частотами от $1$ колебания за период (в смысле buffer size) до $N-1$ колебаний за период.

#### ДПФ комплексной синусоиды

Сигнал: $x_1[n] = e^{i \frac{2 \pi k_0 n}{N}}$

$$
\begin{align*}
X_1\left[k\right] 
	&= \sum_{n=0}^{N-1}x[n] e^{-i \frac{2 \pi k n}{N}} \\
	&= \sum_{n=0}^{N-1}e^{i \frac{2 \pi k_0 n}{N}} e^{-i \frac{2 \pi k n}{N}} \\
	&= \sum_{n=0}^{N-1}e^{-i \frac{2 \pi (k-k_0) n}{N}} \\
	&= \frac{1-e^{-i 2 \pi (k-k_0)} }{1-e^{-i \frac{2 \pi (k-k_0)}{N}} }
\end{align*}
$$

Таким образом (по формуле суммы первых $N$ членов геометрической прогресии):

$$
\begin{cases}
X_1[k] = N, & \text{при } k=k_0 \\
X_1[k] = 0, & \text{при } k \neq k_0
\end{cases}
$$



## Оконные Функции

[Пособие от ИТМО по оконным функциям](https://books.ifmo.ru/file/pdf/2489.pdf)

[Тут есть много информации по разным окнам](https://www.recordingblogs.com/wiki/window)

[Еще статья с анимациями](https://www.pvsm.ru/matematika/355863)

[Из пособия Ховановых - растекание спектра и оконные функции](http://chaos.sgu.ru/kafedra/edu_work/textbook/khovanovs-01/node17.html)


**Сравнение оконных функций:** (01_4T1)

| Название функции                          | Временное представление $w(i)$                             | Спектральная характеристика $W(f)$                          | Ширина основного лепестка (на -3 Дб) | Уровень боковых лепестков |
|-------------------------------------------|------------------------------------------------------------|-------------------------------------------------------------|--------------------------------------|---------------------------|
| Прямоугольное                             | $w_r(i)$                                                   | $W_r(f)$                                                    | 0.89 полосы                          | -13.3 Дб                  |
| Треугольное (окно Бартлетта)              | $1 -2 \vert t(i)\vert$                                     | $(2/N)W^2_r(f/2)$                                           | 1.28 полосы                          | -26.5 Дб                  |
| Косинус-кваднатное (окно Ханна)           | $\cos^2(\pi t(i))$                                         | $0.5W_r(f)+0.25W_r(f-\Delta f)+0.25W_r(f+\Delta f)$         | 1.44 полосы                          | -31.5 Дб                  |
| Приподнятый косинус (окно Хемминга)       | $0.54 +0.46 \cos(2\pi t(i))$                               | $0.54W_r(f)+0.23W_r(f-\Delta f)+0.23W_r(f+\Delta f)$        | 1.30 полосы                          | -42.7 Дб                  |
| Взвешенные косинусы (окно Наттола, $R=3$) | $\sum_{r=0}^{R}a_r\cos(2\pi rt(i))$, где $a_r$ - параметры | $\sum_{r=0}^{R}0.5 a_r(W_r(f-r\Delta f)+W_r(f+r \Delta f))$ | 1.70 полосы                          | -98 Дб                    |


[Habr: Проектирование оконных функций, суммирующихся в единицу с заданным уровнем перекрытия](https://habr.com/ru/post/430536/)

![](Pasted%20image%2020220805194449.png)


Спектрограмма фазы (обычно производной фазы) позволяет понять, где происхоит резкое ее изменение (более или менее шумные участки - 02_4T2). 

Меньше размер fft - больше общей информации, например, о постоянных характеристиках в голосе (гасные), очевидно - меньше разрешение по частоте. Больше размер - можно явнее найти onsets для соло.

## Синусоидальная модель

В ней считается, что сигнал состоит из суммы меняющихся во времени синусоид:
$$y[n] = \sum\limits_{r=1}^{R}A_r[n] \cos(2 \pi f_r[n]n)$$

Если принять $B_f = B_s f_s / M$ и $\Delta  = |f_{k+1} - f_{k}|$
Где 
$B_f$ - ширина главного лепестка в герцах
$B_s$ - ширина главного лепестка в полосах
$f_s$ - частота дискретизации
$M$ - размер окна
$f_{k+1} , f_{k}$ - соседние различимые частоты в герцах 

То размер окна должен быть $$M \geqslant B_{s} \frac{f_s}{\Delta} = B_s \frac{f_s}{|f_{k+1} - f_{k}|}$$
Таким образом, если необходимо различить, например, 440 и 490 герц, в сигнале с частотой дискретизации 44100 и используя окно Хамминга:
$$M \geqslant B_s \frac{f_s}{|f_{k+1} - f_{k}|} = 4 \frac{44100}{|490 - 440|} = 3528$$

### Поиск пиков

Происходит поиск локальных максимумов.
$p_r = mX[k_0]$, если $mX[k_0 - 1] < mX[k_0] > mX[k_0 + 1]$
При недостаточном разрешении по частоте применяется zero-padding. То есть размер для БПФ берется больше размера окна. Однако, иногда целесообразнее использовать квадратичную интерполяцию (так как парабола похожа по форме на главный лепесток спектра оконной функции). 
Для интерполяции возьмем три самых больших значения:
$x[-1] = \alpha = mX[k_{\beta}-1]$
$x[0] = \beta = mX[k_{\beta}]$
$x[1] = \gamma = mX[k_{\beta}+1]$
Тогда центр параболы:
$\hat{k}_p = \hat{k} + \frac{\alpha - \gamma}{2}(\alpha - 2 \beta + \gamma)$
Амплитуда:
$\hat{a} = \beta - \frac{\hat{k}_p}{4}(\alpha - \gamma)$

### Синусоидальные параметры из пиков

(02_5T2)

$$\hat{k}_p = |X[k_p]| + \frac{0.5 \cdot (|X[k_p - 1]| - |X[k_p + 1]|)}{|X[k_p - 1]| - 2\cdot |X[k_p]| + |X[k_p + 1]|}$$
$$f_p = \frac{f_s \cdot \hat{k}_p}{N}$$
$$A_p = |X[k_p]| - 0.25 \cdot(|X[k_p - 1]| - |X[k_p + 1]|) \cdot (\hat{k}_p - k_p)$$
$$ph_p = \sphericalangle X[\hat{k}_p]$$
Считается, что пик стабилен, если он не меняется больше чем на величину некоторого порогового значения для последовательности анализируемых частей. Стабильность определяется по частоте и амплитуде в последовательных кадрах и по производной фазы. Так же есть параметр - минимальная длина трека. Он позволяет отделять короткие гармонические составляющие, например, в перкуссионных звуках.

### Синтез в синусоидальной модели

По сути это обычный аддитивный синтез. Имеется несколько синусоидальных осцилляторов разных частот и их сигналы складываются с некоторыми коэффициентами. 

[Часть видео Andrew Huang](https://youtu.be/Wx_kugSemfY?t=335)

[Часть вебинара Димы 2DCube](https://youtu.be/i3TqCmptn0U?t=4406)


Считать много синусоид может быть слишком дорого, поэтому можно идти от спектра - генерируются главные лепестки окон (например, Блэкмана-Харриса) в нужных местах по частоте и затем произоводится обратное преобразование Фурье. 



